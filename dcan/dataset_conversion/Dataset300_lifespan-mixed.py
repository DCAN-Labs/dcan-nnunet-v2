import SimpleITK
import nibabel
import numpy as np
from batchgenerators.utilities.file_and_folder_operations import *
import shutil
from nnunetv2.dataset_conversion.generate_dataset_json import generate_dataset_json
from nnunetv2.paths import nnUNet_raw



if __name__ == '__main__':
    base = '/scratch.global/lundq163/lifespan-model-training/nnUNet_raw/Dataset300_lifespan-mixed'
    cases = subdirs(base, join=False)

    target_dataset_id = 300
    target_dataset_name = f'Dataset{target_dataset_id:3.0f}_lifespan-mixed'

    maybe_mkdir_p(join(nnUNet_raw, target_dataset_name))
    imagesTr = join(nnUNet_raw, target_dataset_name, 'imagesTr')
    labelsTr = join(nnUNet_raw, target_dataset_name, 'labelsTr')
    maybe_mkdir_p(imagesTr)
    maybe_mkdir_p(labelsTr)
    labels = {
    "Background": 0,
    "unknown-1": 1,
    "Left-Cerebral-White-Matter": 2,
    "Left-Cerebral-Cortex": 3,
    "Left-Lateral-Ventricle": 4,
    "unknown-5": 5,
    "unknown-6": 6,
    "unknown-7": 7,
    "Left-Cerebellum-Cortex": 8,
    "unknown-9": 9,
    "Left-Thalamus-Proper": 10,
    "Left-Caudate": 11,
    "Left-Putamen": 12,
    "Left-Pallidum": 13,
    "3rd-Ventricle": 14,
    "4th-Ventricle": 15,
    "Brain-Stem": 16,
    "Left-Hippocampus": 17,
    "Left-Amygdala": 18,
    "unknown-19": 19,
    "unknown-20": 20,
    "unknown-21": 21,
    "unknown-22": 22,
    "unknown-23": 23,
    "CSF": 24,
    "unknown-25": 25,
    "Left-Accumbens-area": 26,
    "unknown-27": 27,
    "Left-VentralDC": 28,
    "unknown-29": 29,
    "unknown-30": 30,
    "unknown-31": 31,
    "unknown-32": 32,
    "unknown-33": 33,
    "unknown-34": 34,
    "unknown-35": 35,
    "unknown-36": 36,
    "unknown-37": 37,
    "unknown-38": 38,
    "unknown-39": 39,
    "unknown-40": 40,
    "Right-Cerebral-White-Matter": 41,
    "Right-Cerebral-Cortex": 42,
    "Right-Lateral-Ventricle": 43,
    "unknown-44": 44,
    "unknown-45": 45,
    "unknown-46": 46,
    "Right-Cerebellum-Cortex": 47,
    "unknown-48": 48,
    "Right-Thalamus-Proper": 49,
    "Right-Caudate": 50,
    "Right-Putamen": 51,
    "Right-Pallidum": 52,
    "Right-Hippocampus": 53,
    "Right-Amygdala": 54,
    "unknown-55": 55,
    "unknown-56": 56,
    "unknown-57": 57,
    "Right-Accumbens-area": 58,
    "unknown-59": 59,
    "Right-VentralDC": 60,
    "unknown-61": 61,
    "unknown-62": 62,
    "unknown-63": 63,
    "unknown-64": 64,
    "unknown-65": 65,
    "unknown-66": 66,
    "unknown-67": 67,
    "unknown-68": 68,
    "unknown-69": 69,
    "unknown-70": 70,
    "unknown-71": 71,
    "unknown-72": 72,
    "unknown-73": 73,
    "unknown-74": 74,
    "unknown-75": 75,
    "unknown-76": 76,
    "unknown-77": 77,
    "unknown-78": 78,
    "unknown-79": 79,
    "unknown-80": 80,
    "unknown-81": 81,
    "unknown-82": 82,
    "unknown-83": 83,
    "unknown-84": 84,
    "unknown-85": 85,
    "unknown-86": 86,
    "unknown-87": 87,
    "unknown-88": 88,
    "unknown-89": 89,
    "unknown-90": 90,
    "unknown-91": 91,
    "unknown-92": 92,
    "unknown-93": 93,
    "unknown-94": 94,
    "unknown-95": 95,
    "unknown-96": 96,
    "unknown-97": 97,
    "unknown-98": 98,
    "unknown-99": 99,
    "unknown-100": 100,
    "unknown-101": 101,
    "unknown-102": 102,
    "unknown-103": 103,
    "unknown-104": 104,
    "unknown-105": 105,
    "unknown-106": 106,
    "unknown-107": 107,
    "unknown-108": 108,
    "unknown-109": 109,
    "unknown-110": 110,
    "unknown-111": 111,
    "unknown-112": 112,
    "unknown-113": 113,
    "unknown-114": 114,
    "unknown-115": 115,
    "unknown-116": 116,
    "unknown-117": 117,
    "unknown-118": 118,
    "unknown-119": 119,
    "unknown-120": 120,
    "unknown-121": 121,
    "unknown-122": 122,
    "unknown-123": 123,
    "unknown-124": 124,
    "unknown-125": 125,
    "unknown-126": 126,
    "unknown-127": 127,
    "unknown-128": 128,
    "unknown-129": 129,
    "unknown-130": 130,
    "unknown-131": 131,
    "unknown-132": 132,
    "unknown-133": 133,
    "unknown-134": 134,
    "unknown-135": 135,
    "unknown-136": 136,
    "unknown-137": 137,
    "unknown-138": 138,
    "unknown-139": 139,
    "unknown-140": 140,
    "unknown-141": 141,
    "unknown-142": 142,
    "unknown-143": 143,
    "unknown-144": 144,
    "unknown-145": 145,
    "unknown-146": 146,
    "unknown-147": 147,
    "unknown-148": 148,
    "unknown-149": 149,
    "unknown-150": 150,
    "unknown-151": 151,
    "unknown-152": 152,
    "unknown-153": 153,
    "unknown-154": 154,
    "unknown-155": 155,
    "unknown-156": 156,
    "unknown-157": 157,
    "unknown-158": 158,
    "Left-Cerebral-WM-unmyelinated": 159,
    "Right-Cerebral-WM-unmyelinated": 160,
    "Left-Cerebral-WM-myelinated": 161,
    "Right-Cerebral-WM-myelinated": 162,
    "unknown-163": 163,
    "unknown-164": 164,
    "unknown-165": 165,
    "unknown-166": 166,
    "unknown-167": 167,
    "unknown-168": 168,
    "unknown-169": 169,
    "unknown-170": 170,
    "unknown-171": 171,
    "Vermis": 172
}

    generate_dataset_json(
        join(nnUNet_raw, target_dataset_name),
        {0: 'T1'},  # Modality dictionary
        labels,
        len(cases),
        '.nii.gz',
        release='1.0.0'#,
        #reference='https://zenodo.org/records/11367005',
        #license='see reference'
    )